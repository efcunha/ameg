<!DOCTYPE html>
<html>
<head>
    <title>AMEG - Gráficos</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial; margin: 0; background: #f4f4f4; }
        .header { background: #2c3e50; color: white; padding: 20px; }
        .nav { background: #34495e; padding: 15px; }
        .nav a { color: white; text-decoration: none; padding: 10px 20px; margin-right: 10px; background: #3498db; border-radius: 5px; }
        .nav a:hover { background: #2980b9; }
        .container { padding: 20px; }
        .logout { float: right; }
    </style>
</head>
<body>
    <div class="header">
        <h1>AMEG - Sistema de Cadastro</h1>
        <span>Bem-vindo, {{ session.usuario }}!</span>
        <a href="/logout" class="logout" style="color: white; text-decoration: none;">Sair</a>
    </div>
    
    <div class="nav">
        <a href="/dashboard">Dashboard</a>
        <a href="/cadastrar">Novo Cadastro</a>
        <a href="/relatorios">Relatórios</a>
        <a href="/charts" style="background: #e74c3c;">📊 Gráficos</a>
        {% if tem_permissao_caixa %}
        <a href="/caixa">💰 Caixa</a>
        {% endif %}
        <a href="/arquivos_cadastros">📁 Arquivos</a>
        {% if is_admin_user(session.usuario) %}
        <a href="/usuarios">👥 Usuários</a>
        <a href="/auditoria">🔍 Auditoria</a>
        {% endif %}
    </div>

    <div class="container" id="main-container">
        <div style="text-align: center; padding: 50px;">
            <h2>📊 Carregando Gráficos...</h2>
            <p>Aguarde enquanto os dados são processados.</p>
        </div>
    </div>

    <script>
        console.log('🚀 INICIANDO GRÁFICOS ÚNICOS');
        
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(loadCharts, 1000);
        });
        
        async function loadCharts() {
            try {
                console.log('📡 Buscando dados...');
                const response = await fetch('/api/charts/demografia?periodo=todos&bairro=todos');
                const data = await response.json();
                
                console.log('📦 Dados:', data);
                
                const container = document.getElementById('main-container');
                container.innerHTML = `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 15px; margin-bottom: 30px; text-align: center;">
                        <h1 style="color: white; margin: 0; font-size: 2.5em;">📊 Dashboard AMEG</h1>
                        <p style="color: rgba(255,255,255,0.9); margin: 10px 0 0 0;">Dados em Tempo Real</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px;">
                        
                        <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
                            <h3 style="color: #3498db; margin-bottom: 20px;">👥 Faixa Etária</h3>
                            ${createBars(data.idade, 'faixa', 'total', '#3498db')}
                        </div>
                        
                        <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
                            <h3 style="color: #e74c3c; margin-bottom: 20px;">🏘️ Bairros</h3>
                            ${createBars(data.bairros, 'bairro', 'total', '#e74c3c')}
                        </div>
                        
                        <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); grid-column: 1 / -1;">
                            <h3 style="color: #27ae60; margin-bottom: 20px;">📈 Evolução</h3>
                            ${createBars(data.evolucao, 'mes', 'total', '#27ae60')}
                        </div>
                        
                    </div>
                    
                    <div style="margin-top: 30px; padding: 20px; background: #2ecc71; border-radius: 10px; color: white; text-align: center;">
                        <strong>✅ Gráficos Carregados!</strong> • Total: ${getTotalCount(data)} cadastros
                    </div>
                `;
                
            } catch (error) {
                console.error('❌ Erro:', error);
                document.getElementById('main-container').innerHTML = `
                    <div style="background: #f8d7da; color: #721c24; padding: 20px; border-radius: 10px; text-align: center;">
                        <h3>❌ Erro ao Carregar</h3>
                        <p>${error.message}</p>
                        <button onclick="loadCharts()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px;">Tentar Novamente</button>
                    </div>
                `;
            }
        }
        
        function createBars(data, labelKey, valueKey, color) {
            if (!data || data.length === 0) return '<p>Nenhum dado</p>';
            
            const max = Math.max(...data.map(d => d[valueKey]));
            let html = '';
            
            data.forEach(item => {
                const percent = (item[valueKey] / max) * 100;
                html += `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span><strong>${item[labelKey]}</strong></span>
                            <span style="color: ${color}; font-weight: bold;">${item[valueKey]}</span>
                        </div>
                        <div style="background: #f0f0f0; height: 15px; border-radius: 8px;">
                            <div style="background: ${color}; height: 100%; width: ${percent}%; border-radius: 8px; transition: width 0.5s;"></div>
                        </div>
                    </div>
                `;
            });
            
            return html;
        }
        
        function getTotalCount(data) {
            if (data.idade && data.idade.length > 0) {
                return data.idade.reduce((sum, item) => sum + item.total, 0);
            }
            return 0;
        }
        
        function aplicarFiltros() {
            loadCharts();
        }
    </script>
</body>
</html>
