<!DOCTYPE html>
<html>
<head>
    <title>AMEG - Gr√°ficos Internos</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background: #f8f9fa; }
        .header { background: linear-gradient(135deg, #2c3e50, #34495e); color: white; padding: 20px; }
        .nav { background: #34495e; padding: 15px; }
        .nav a { color: white; text-decoration: none; padding: 10px 20px; margin-right: 10px; background: #3498db; border-radius: 8px; transition: all 0.3s; }
        .nav a:hover { background: #2980b9; transform: translateY(-2px); }
        .nav a.active { background: #e74c3c; }
        .container { padding: 20px; max-width: 1200px; margin: 0 auto; }
        .logout { float: right; }
        .filters { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 30px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-weight: 600; color: #2c3e50; margin-bottom: 5px; }
        .filter-group select { padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px; }
        .btn-primary { background: linear-gradient(45deg, #3498db, #2980b9); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4); }
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 30px; }
        .chart-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05); min-height: 350px; }
        .chart-title { font-size: 1.3em; font-weight: 600; color: #2c3e50; margin-bottom: 20px; display: flex; align-items: center; }
        .chart-icon { background: linear-gradient(45deg, #3498db, #2980b9); color: white; padding: 8px; border-radius: 50%; margin-right: 12px; font-size: 0.9em; }
        .full-width { grid-column: 1 / -1; }
        canvas { border-radius: 8px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>AMEG - Sistema de Cadastro</h1>
        <span>Bem-vindo, {{ session.usuario }}!</span>
        <a href="/logout" class="logout" style="color: white; text-decoration: none;">Sair</a>
    </div>
    
    <div class="nav">
        <a href="/dashboard">Dashboard</a>
        <a href="/cadastrar">Novo Cadastro</a>
        <a href="/relatorios">Relat√≥rios</a>
        <a href="/notificacoes">üîî Notifica√ß√µes</a>
        <a href="/charts" class="active">üìä Gr√°ficos</a>
        {% if tem_permissao_caixa %}
        <a href="/caixa">üí∞ Caixa</a>
        {% endif %}
        <a href="/arquivos_cadastros">üìÅ Arquivos</a>
        {% if is_admin_user(session.usuario) %}
        <a href="/usuarios">üë• Usu√°rios</a>
        <a href="/auditoria">üîç Auditoria</a>
        {% endif %}
    </div>

    <div class="container">
        <!-- Filtros -->
        <div class="filters">
            <div class="filter-group">
                <label>üìÖ Per√≠odo:</label>
                <select id="filtro-periodo">
                    <option value="todos">Todos os per√≠odos</option>
                    <option value="6m">√öltimos 6 meses</option>
                    <option value="1a">√öltimo ano</option>
                </select>
            </div>
            <div class="filter-group">
                <label>üèòÔ∏è Bairro:</label>
                <select id="filtro-bairro">
                    <option value="todos">Todos os bairros</option>
                </select>
            </div>
            <div class="filter-group">
                <label>üë• Faixa Et√°ria:</label>
                <select id="filtro-idade">
                    <option value="todos">Todas as idades</option>
                    <option value="menor18">Menor de 18 anos</option>
                    <option value="18-29">18 a 29 anos</option>
                    <option value="30-49">30 a 49 anos</option>
                    <option value="50+">50 anos ou mais</option>
                </select>
            </div>
            <button onclick="aplicarFiltros()" class="btn-primary">üîÑ Aplicar Filtros</button>
            <button onclick="limparFiltros()" class="btn-primary" style="background: linear-gradient(45deg, #e74c3c, #c0392b);">üóëÔ∏è Limpar</button>
        </div>

        <!-- Header do Dashboard -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 15px; margin-bottom: 30px; text-align: center;">
            <h1 style="color: white; margin: 0; font-size: 2.5em; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">üìä Dashboard AMEG Interno</h1>
            <p style="color: rgba(255,255,255,0.9); margin: 10px 0 0 0; font-size: 1.2em;" id="dashboard-subtitle">Carregando dados...</p>
        </div>

        <!-- Gr√°ficos -->
        <div class="charts-grid">
            <!-- Faixa Et√°ria -->
            <div class="chart-card">
                <div class="chart-title">
                    <span class="chart-icon" style="background: linear-gradient(45deg, #FF6B6B, #FF5252);">üë•</span>
                    Distribui√ß√£o por Faixa Et√°ria
                </div>
                <canvas id="idadeChart" width="450" height="350"></canvas>
            </div>

            <!-- Bairros -->
            <div class="chart-card">
                <div class="chart-title">
                    <span class="chart-icon" style="background: linear-gradient(45deg, #4ECDC4, #26C6DA);">üèòÔ∏è</span>
                    Top 10 Bairros
                    <div style="margin-left: auto; font-size: 0.8em; color: #666;">
                        <button onclick="toggleBairrosView()" id="toggle-bairros" style="background: #3498db; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 11px;">
                            üìä Ver Todos
                        </button>
                    </div>
                </div>
                <canvas id="bairrosChart" width="400" height="300"></canvas>
                <div id="bairros-lista" style="display: none; max-height: 300px; overflow-y: auto; margin-top: 10px;"></div>
            </div>

            <!-- Evolu√ß√£o -->
            <div class="chart-card full-width">
                <div class="chart-title">
                    <span class="chart-icon" style="background: linear-gradient(45deg, #45B7D1, #2196F3);">üìà</span>
                    Evolu√ß√£o de Cadastros ao Longo do Tempo
                </div>
                <canvas id="evolucaoChart" width="800" height="250"></canvas>
            </div>
        </div>

        <!-- Status -->
        <div id="status-message" style="margin-top: 30px; padding: 20px; background: #d4edda; border-radius: 10px; color: #155724; text-align: center; display: none;">
            <strong>‚úÖ Gr√°ficos Internos Carregados!</strong><br>
            <span>Sistema de gr√°ficos nativo AMEG ‚Ä¢ Sem depend√™ncias externas</span>
        </div>
    </div>

    <script>
        console.log('üöÄ INICIANDO SISTEMA DE GR√ÅFICOS INTERNO AMEG');
        
        let allBairrosData = [];
        let showingAllBairros = false;
        
        // Polyfill para roundRect
        if (!CanvasRenderingContext2D.prototype.roundRect) {
            CanvasRenderingContext2D.prototype.roundRect = function(x, y, width, height, radius) {
                this.beginPath();
                this.moveTo(x + radius, y);
                this.lineTo(x + width - radius, y);
                this.quadraticCurveTo(x + width, y, x + width, y + radius);
                this.lineTo(x + width, y + height - radius);
                this.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
                this.lineTo(x + radius, y + height);
                this.quadraticCurveTo(x, y + height, x, y + height - radius);
                this.lineTo(x, y + radius);
                this.quadraticCurveTo(x, y, x + radius, y);
                this.closePath();
            };
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            loadFilterOptions();
            setTimeout(loadAllCharts, 1000);
        });
        
        async function loadFilterOptions() {
            try {
                const response = await fetch('/api/charts/filters');
                const data = await response.json();
                
                const bairroSelect = document.getElementById('filtro-bairro');
                data.bairros.forEach(bairro => {
                    const option = document.createElement('option');
                    option.value = bairro.value;
                    option.textContent = bairro.label;
                    bairroSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar filtros:', error);
            }
        }
        
        async function loadAllCharts() {
            try {
                const periodo = document.getElementById('filtro-periodo').value;
                const bairro = document.getElementById('filtro-bairro').value;
                const idade = document.getElementById('filtro-idade').value;
                
                const params = new URLSearchParams();
                if (periodo !== 'todos') params.append('periodo', periodo);
                if (bairro !== 'todos') params.append('bairro', bairro);
                if (idade !== 'todos') params.append('idade', idade);
                
                const suffix = params.toString() ? `?${params.toString()}` : '';
                
                console.log('üì° Carregando dados:', suffix);
                
                const response = await fetch(`/api/charts/demografia${suffix}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                console.log('üì¶ Dados recebidos:', data);
                
                // Criar gr√°ficos nativos
                drawDoughnutChart('idadeChart', data.idade, 'faixa', 'total');
                
                // Salvar dados completos dos bairros
                allBairrosData = data.bairros;
                drawBarChart('bairrosChart', data.bairros.slice(0, 10), 'bairro', 'total');
                
                drawLineChart('evolucaoChart', data.evolucao, 'mes', 'total');
                
                // Atualizar subtitle
                const total = data.idade.reduce((sum, item) => sum + item.total, 0);
                const filtrosAtivos = [];
                if (periodo !== 'todos') filtrosAtivos.push(periodo === '6m' ? '√öltimos 6 meses' : '√öltimo ano');
                if (bairro !== 'todos') filtrosAtivos.push(bairro);
                if (idade !== 'todos') filtrosAtivos.push(idade);
                
                const filtrosTexto = filtrosAtivos.length > 0 ? filtrosAtivos.join(' ‚Ä¢ ') : 'Todos os dados';
                document.getElementById('dashboard-subtitle').textContent = `${total} cadastros ‚Ä¢ ${filtrosTexto}`;
                
                document.getElementById('status-message').style.display = 'block';
                
            } catch (error) {
                console.error('‚ùå Erro:', error);
                document.getElementById('dashboard-subtitle').textContent = `Erro: ${error.message}`;
            }
        }
        
        function drawDoughnutChart(canvasId, data, labelKey, valueKey) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (!data || data.length === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '18px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Nenhum dado para', canvas.width/2, canvas.height/2 - 10);
                ctx.fillText('esta faixa et√°ria', canvas.width/2, canvas.height/2 + 15);
                return;
            }
            
            const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'];
            const total = data.reduce((sum, item) => sum + item[valueKey], 0);
            
            let currentAngle = -Math.PI / 2;
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2 - 40;
            const radius = Math.min(centerX, centerY) - 30;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Desenhar fatias
            data.forEach((item, index) => {
                const sliceAngle = (item[valueKey] / total) * 2 * Math.PI;
                
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.lineTo(centerX, centerY);
                ctx.fillStyle = colors[index % colors.length];
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                currentAngle += sliceAngle;
            });
            
            // Legenda horizontal embaixo
            const legendY = canvas.height - 60;
            const legendItemWidth = canvas.width / data.length;
            
            data.forEach((item, index) => {
                const x = index * legendItemWidth + 10;
                
                // Quadrado colorido
                ctx.fillStyle = colors[index % colors.length];
                ctx.fillRect(x, legendY, 12, 12);
                
                // Texto
                ctx.fillStyle = '#333';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(`${item[labelKey]}: ${item[valueKey]}`, x + 16, legendY + 10);
            });
        }
        
        function drawBarChart(canvasId, data, labelKey, valueKey) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (!data || data.length === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '18px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Nenhum bairro', canvas.width/2, canvas.height/2 - 10);
                ctx.fillText('com dados', canvas.width/2, canvas.height/2 + 15);
                return;
            }
            
            const maxValue = Math.max(...data.map(d => d[valueKey]));
            const barWidth = (canvas.width - 40) / data.length;
            const chartHeight = canvas.height - 80;
            
            data.forEach((item, index) => {
                const barHeight = (item[valueKey] / maxValue) * chartHeight;
                const x = 20 + index * barWidth;
                const y = canvas.height - 60 - barHeight;
                
                // Gradiente para as barras
                const gradient = ctx.createLinearGradient(0, y, 0, y + barHeight);
                gradient.addColorStop(0, '#4ECDC4');
                gradient.addColorStop(1, '#26C6DA');
                
                // Barra com bordas arredondadas
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.roundRect(x + 5, y, barWidth - 15, barHeight, 4);
                ctx.fill();
                
                // Valor no topo da barra
                ctx.fillStyle = '#333';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(item[valueKey], x + barWidth/2, y - 8);
                
                // Label embaixo (texto leg√≠vel)
                ctx.fillStyle = '#555';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                
                // Quebrar texto longo
                const label = item[labelKey];
                const words = label.split(' ');
                if (words.length > 2) {
                    ctx.fillText(words.slice(0, 2).join(' '), x + barWidth/2, canvas.height - 35);
                    ctx.fillText(words.slice(2).join(' '), x + barWidth/2, canvas.height - 20);
                } else {
                    ctx.fillText(label, x + barWidth/2, canvas.height - 25);
                }
            });
        }
        
        function drawLineChart(canvasId, data, labelKey, valueKey) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            console.log('üìà Dados para evolu√ß√£o:', data);
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (!data || data.length === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '18px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Nenhum dado de', canvas.width/2, canvas.height/2 - 10);
                ctx.fillText('evolu√ß√£o dispon√≠vel', canvas.width/2, canvas.height/2 + 15);
                return;
            }
            
            const maxValue = Math.max(...data.map(d => d[valueKey]));
            const minValue = Math.min(...data.map(d => d[valueKey]));
            const range = maxValue - minValue || 1;
            const stepX = (canvas.width - 120) / Math.max(data.length - 1, 1);
            const chartHeight = canvas.height - 100;
            
            // Grid de fundo
            ctx.strokeStyle = '#f0f0f0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = 50 + (i * chartHeight / 5);
                ctx.beginPath();
                ctx.moveTo(60, y);
                ctx.lineTo(canvas.width - 40, y);
                ctx.stroke();
            }
            
            // √Årea de fundo gradiente
            const gradient = ctx.createLinearGradient(0, 50, 0, 50 + chartHeight);
            gradient.addColorStop(0, 'rgba(69, 183, 209, 0.3)');
            gradient.addColorStop(1, 'rgba(69, 183, 209, 0.05)');
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.moveTo(60, canvas.height - 50);
            
            data.forEach((item, index) => {
                const x = 60 + index * stepX;
                const y = 50 + chartHeight - ((item[valueKey] - minValue) / range) * chartHeight;
                ctx.lineTo(x, y);
            });
            
            ctx.lineTo(60 + (data.length - 1) * stepX, canvas.height - 50);
            ctx.closePath();
            ctx.fill();
            
            // Linha principal com sombra
            ctx.shadowColor = 'rgba(69, 183, 209, 0.3)';
            ctx.shadowBlur = 4;
            ctx.shadowOffsetY = 2;
            
            ctx.strokeStyle = '#45B7D1';
            ctx.lineWidth = 4;
            ctx.beginPath();
            
            data.forEach((item, index) => {
                const x = 60 + index * stepX;
                const y = 50 + chartHeight - ((item[valueKey] - minValue) / range) * chartHeight;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            ctx.shadowBlur = 0;
            
            // Pontos e valores
            data.forEach((item, index) => {
                const x = 60 + index * stepX;
                const y = 50 + chartHeight - ((item[valueKey] - minValue) / range) * chartHeight;
                
                // Ponto com borda
                ctx.fillStyle = '#45B7D1';
                ctx.beginPath();
                ctx.arc(x, y, 8, 0, 2 * Math.PI);
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 3;
                ctx.stroke();
                
                // Valor acima do ponto
                ctx.fillStyle = '#333';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(item[valueKey], x, y - 20);
                
                // Label embaixo
                ctx.fillStyle = '#666';
                ctx.font = 'bold 14px Arial';
                ctx.fillText(item[labelKey], x, canvas.height - 20);
            });
            
            // T√≠tulo do eixo Y
            ctx.save();
            ctx.translate(20, canvas.height/2);
            ctx.rotate(-Math.PI/2);
            ctx.fillStyle = '#666';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('N√∫mero de Cadastros', 0, 0);
            ctx.restore();
        }
        
        function aplicarFiltros() {
            console.log('üîÑ Aplicando filtros...');
            loadAllCharts();
        }
        
        function limparFiltros() {
            console.log('üóëÔ∏è Limpando filtros...');
            document.getElementById('filtro-periodo').value = 'todos';
            document.getElementById('filtro-bairro').value = 'todos';
            document.getElementById('filtro-idade').value = 'todos';
            loadAllCharts();
        }
        
        function toggleBairrosView() {
            const canvas = document.getElementById('bairrosChart');
            const lista = document.getElementById('bairros-lista');
            const button = document.getElementById('toggle-bairros');
            
            if (showingAllBairros) {
                // Mostrar gr√°fico (top 10)
                canvas.style.display = 'block';
                lista.style.display = 'none';
                button.textContent = 'üìä Ver Todos';
                drawBarChart('bairrosChart', allBairrosData.slice(0, 10), 'bairro', 'total');
                showingAllBairros = false;
            } else {
                // Mostrar lista completa
                canvas.style.display = 'none';
                lista.style.display = 'block';
                button.textContent = 'üìä Ver Gr√°fico';
                
                let html = '<h4 style="margin-top: 0;">üìã Todos os Bairros:</h4>';
                allBairrosData.forEach((item, index) => {
                    const color = index < 10 ? '#4ECDC4' : '#95a5a6';
                    html += `
                        <div style="display: flex; justify-content: space-between; padding: 8px; margin: 5px 0; background: ${color}20; border-radius: 5px; border-left: 4px solid ${color};">
                            <span style="font-weight: bold;">${index + 1}. ${item.bairro}</span>
                            <span style="color: ${color}; font-weight: bold;">${item.total} cadastros</span>
                        </div>
                    `;
                });
                lista.innerHTML = html;
                showingAllBairros = true;
            }
        }
    </script>
</body>
</html>
