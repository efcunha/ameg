<!DOCTYPE html>
<html>
<head>
    <title>AMEG - Gr√°ficos Internos</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background: #f8f9fa; }
        .header { background: linear-gradient(135deg, #2c3e50, #34495e); color: white; padding: 20px; }
        .nav { background: #34495e; padding: 15px; }
        .nav a { color: white; text-decoration: none; padding: 10px 20px; margin-right: 10px; background: #3498db; border-radius: 8px; transition: all 0.3s; }
        .nav a:hover { background: #2980b9; transform: translateY(-2px); }
        .nav a.active { background: #e74c3c; }
        .container { padding: 20px; max-width: 1200px; margin: 0 auto; }
        .logout { float: right; }
        .filters { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 30px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-weight: 600; color: #2c3e50; margin-bottom: 5px; }
        .filter-group select { padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px; }
        .btn-primary { background: linear-gradient(45deg, #3498db, #2980b9); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4); }
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .chart-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05); }
        .chart-title { font-size: 1.3em; font-weight: 600; color: #2c3e50; margin-bottom: 20px; display: flex; align-items: center; }
        .chart-icon { background: linear-gradient(45deg, #3498db, #2980b9); color: white; padding: 8px; border-radius: 50%; margin-right: 12px; font-size: 0.9em; }
        .full-width { grid-column: 1 / -1; }
        canvas { border-radius: 8px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>AMEG - Sistema de Cadastro</h1>
        <span>Bem-vindo, {{ session.usuario }}!</span>
        <a href="/logout" class="logout" style="color: white; text-decoration: none;">Sair</a>
    </div>
    
    <div class="nav">
        <a href="/dashboard">Dashboard</a>
        <a href="/cadastrar">Novo Cadastro</a>
        <a href="/relatorios">Relat√≥rios</a>
        <a href="/charts" class="active">üìä Gr√°ficos</a>
        {% if tem_permissao_caixa %}
        <a href="/caixa">üí∞ Caixa</a>
        {% endif %}
        <a href="/arquivos_cadastros">üìÅ Arquivos</a>
        {% if is_admin_user(session.usuario) %}
        <a href="/usuarios">üë• Usu√°rios</a>
        <a href="/auditoria">üîç Auditoria</a>
        {% endif %}
    </div>

    <div class="container">
        <!-- Filtros -->
        <div class="filters">
            <div class="filter-group">
                <label>üìÖ Per√≠odo:</label>
                <select id="filtro-periodo">
                    <option value="todos">Todos os per√≠odos</option>
                    <option value="6m">√öltimos 6 meses</option>
                    <option value="1a">√öltimo ano</option>
                </select>
            </div>
            <div class="filter-group">
                <label>üèòÔ∏è Bairro:</label>
                <select id="filtro-bairro">
                    <option value="todos">Todos os bairros</option>
                </select>
            </div>
            <button onclick="aplicarFiltros()" class="btn-primary">üîÑ Aplicar Filtros</button>
        </div>

        <!-- Header do Dashboard -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 15px; margin-bottom: 30px; text-align: center;">
            <h1 style="color: white; margin: 0; font-size: 2.5em; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">üìä Dashboard AMEG Interno</h1>
            <p style="color: rgba(255,255,255,0.9); margin: 10px 0 0 0; font-size: 1.2em;" id="dashboard-subtitle">Carregando dados...</p>
        </div>

        <!-- Gr√°ficos -->
        <div class="charts-grid">
            <!-- Faixa Et√°ria -->
            <div class="chart-card">
                <div class="chart-title">
                    <span class="chart-icon" style="background: linear-gradient(45deg, #FF6B6B, #FF5252);">üë•</span>
                    Distribui√ß√£o por Faixa Et√°ria
                </div>
                <canvas id="idadeChart" width="300" height="200"></canvas>
            </div>

            <!-- Bairros -->
            <div class="chart-card">
                <div class="chart-title">
                    <span class="chart-icon" style="background: linear-gradient(45deg, #4ECDC4, #26C6DA);">üèòÔ∏è</span>
                    Top Bairros
                </div>
                <canvas id="bairrosChart" width="300" height="200"></canvas>
            </div>

            <!-- Evolu√ß√£o -->
            <div class="chart-card full-width">
                <div class="chart-title">
                    <span class="chart-icon" style="background: linear-gradient(45deg, #45B7D1, #2196F3);">üìà</span>
                    Evolu√ß√£o de Cadastros
                </div>
                <canvas id="evolucaoChart" width="600" height="200"></canvas>
            </div>
        </div>

        <!-- Status -->
        <div id="status-message" style="margin-top: 30px; padding: 20px; background: #d4edda; border-radius: 10px; color: #155724; text-align: center; display: none;">
            <strong>‚úÖ Gr√°ficos Internos Carregados!</strong><br>
            <span>Sistema de gr√°ficos nativo AMEG ‚Ä¢ Sem depend√™ncias externas</span>
        </div>
    </div>

    <script>
        console.log('üöÄ INICIANDO SISTEMA DE GR√ÅFICOS INTERNO AMEG');
        
        // Polyfill para roundRect
        if (!CanvasRenderingContext2D.prototype.roundRect) {
            CanvasRenderingContext2D.prototype.roundRect = function(x, y, width, height, radius) {
                this.beginPath();
                this.moveTo(x + radius, y);
                this.lineTo(x + width - radius, y);
                this.quadraticCurveTo(x + width, y, x + width, y + radius);
                this.lineTo(x + width, y + height - radius);
                this.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
                this.lineTo(x + radius, y + height);
                this.quadraticCurveTo(x, y + height, x, y + height - radius);
                this.lineTo(x, y + radius);
                this.quadraticCurveTo(x, y, x + radius, y);
                this.closePath();
            };
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            loadFilterOptions();
            setTimeout(loadAllCharts, 1000);
        });
        
        async function loadFilterOptions() {
            try {
                const response = await fetch('/api/charts/filters');
                const data = await response.json();
                
                const bairroSelect = document.getElementById('filtro-bairro');
                data.bairros.forEach(bairro => {
                    const option = document.createElement('option');
                    option.value = bairro.value;
                    option.textContent = bairro.label;
                    bairroSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar filtros:', error);
            }
        }
        
        async function loadAllCharts() {
            try {
                const periodo = document.getElementById('filtro-periodo').value;
                const bairro = document.getElementById('filtro-bairro').value;
                
                const params = new URLSearchParams();
                if (periodo !== 'todos') params.append('periodo', periodo);
                if (bairro !== 'todos') params.append('bairro', bairro);
                
                const suffix = params.toString() ? `?${params.toString()}` : '';
                
                console.log('üì° Carregando dados:', suffix);
                
                const response = await fetch(`/api/charts/demografia${suffix}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                console.log('üì¶ Dados recebidos:', data);
                
                // Criar gr√°ficos nativos
                drawDoughnutChart('idadeChart', data.idade, 'faixa', 'total');
                drawBarChart('bairrosChart', data.bairros, 'bairro', 'total');
                drawLineChart('evolucaoChart', data.evolucao, 'mes', 'total');
                
                // Atualizar subtitle
                const total = data.idade.reduce((sum, item) => sum + item.total, 0);
                document.getElementById('dashboard-subtitle').textContent = `${total} cadastros ‚Ä¢ ${periodo === 'todos' ? 'Todos os per√≠odos' : periodo} ‚Ä¢ ${bairro === 'todos' ? 'Todos os bairros' : bairro}`;
                
                document.getElementById('status-message').style.display = 'block';
                
            } catch (error) {
                console.error('‚ùå Erro:', error);
                document.getElementById('dashboard-subtitle').textContent = `Erro: ${error.message}`;
            }
        }
        
        function drawDoughnutChart(canvasId, data, labelKey, valueKey) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            if (!data || data.length === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Nenhum dado', canvas.width/2, canvas.height/2);
                return;
            }
            
            const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'];
            const total = data.reduce((sum, item) => sum + item[valueKey], 0);
            
            let currentAngle = -Math.PI / 2;
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2 - 20;
            const radius = Math.min(centerX, centerY) - 40;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Desenhar fatias
            data.forEach((item, index) => {
                const sliceAngle = (item[valueKey] / total) * 2 * Math.PI;
                
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.lineTo(centerX, centerY);
                ctx.fillStyle = colors[index % colors.length];
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                currentAngle += sliceAngle;
            });
            
            // Legenda horizontal embaixo
            const legendY = canvas.height - 40;
            const legendItemWidth = canvas.width / data.length;
            
            data.forEach((item, index) => {
                const x = index * legendItemWidth + 10;
                
                // Quadrado colorido
                ctx.fillStyle = colors[index % colors.length];
                ctx.fillRect(x, legendY, 12, 12);
                
                // Texto
                ctx.fillStyle = '#333';
                ctx.font = '11px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(`${item[labelKey]}: ${item[valueKey]}`, x + 16, legendY + 10);
            });
        }
        
        function drawBarChart(canvasId, data, labelKey, valueKey) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            if (!data || data.length === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Nenhum dado', canvas.width/2, canvas.height/2);
                return;
            }
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const maxValue = Math.max(...data.map(d => d[valueKey]));
            const barWidth = (canvas.width - 40) / data.length;
            const chartHeight = canvas.height - 80;
            
            data.forEach((item, index) => {
                const barHeight = (item[valueKey] / maxValue) * chartHeight;
                const x = 20 + index * barWidth;
                const y = canvas.height - 60 - barHeight;
                
                // Gradiente para as barras
                const gradient = ctx.createLinearGradient(0, y, 0, y + barHeight);
                gradient.addColorStop(0, '#4ECDC4');
                gradient.addColorStop(1, '#26C6DA');
                
                // Barra com bordas arredondadas
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.roundRect(x + 5, y, barWidth - 15, barHeight, 4);
                ctx.fill();
                
                // Valor no topo da barra
                ctx.fillStyle = '#333';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(item[valueKey], x + barWidth/2, y - 8);
                
                // Label embaixo (texto leg√≠vel)
                ctx.fillStyle = '#555';
                ctx.font = '11px Arial';
                ctx.textAlign = 'center';
                
                // Quebrar texto longo
                const label = item[labelKey];
                const words = label.split(' ');
                if (words.length > 2) {
                    ctx.fillText(words.slice(0, 2).join(' '), x + barWidth/2, canvas.height - 35);
                    ctx.fillText(words.slice(2).join(' '), x + barWidth/2, canvas.height - 20);
                } else {
                    ctx.fillText(label, x + barWidth/2, canvas.height - 25);
                }
            });
        }
        
        function drawLineChart(canvasId, data, labelKey, valueKey) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            console.log('üìà Dados para linha:', data);
            
            if (!data || data.length === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Nenhum dado dispon√≠vel', canvas.width/2, canvas.height/2);
                return;
            }
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const maxValue = Math.max(...data.map(d => d[valueKey]));
            const stepX = (canvas.width - 100) / Math.max(data.length - 1, 1);
            const chartHeight = canvas.height - 80;
            
            // √Årea de fundo
            ctx.fillStyle = 'rgba(69, 183, 209, 0.1)';
            ctx.beginPath();
            ctx.moveTo(50, canvas.height - 40);
            
            data.forEach((item, index) => {
                const x = 50 + index * stepX;
                const y = canvas.height - 40 - (item[valueKey] / maxValue) * chartHeight;
                ctx.lineTo(x, y);
            });
            
            ctx.lineTo(50 + (data.length - 1) * stepX, canvas.height - 40);
            ctx.closePath();
            ctx.fill();
            
            // Linha principal
            ctx.strokeStyle = '#45B7D1';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            data.forEach((item, index) => {
                const x = 50 + index * stepX;
                const y = canvas.height - 40 - (item[valueKey] / maxValue) * chartHeight;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
                
                // Pontos
                ctx.fillStyle = '#45B7D1';
                ctx.beginPath();
                ctx.arc(x, y, 6, 0, 2 * Math.PI);
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();
                ctx.lineWidth = 3;
                ctx.strokeStyle = '#45B7D1';
                
                // Valor
                ctx.fillStyle = '#333';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(item[valueKey], x, y - 15);
                
                // Label
                ctx.font = '12px Arial';
                ctx.fillText(item[labelKey], x, canvas.height - 15);
            });
            
            ctx.stroke();
        }
        
        function aplicarFiltros() {
            console.log('üîÑ Aplicando filtros...');
            loadAllCharts();
        }
    </script>
</body>
</html>
